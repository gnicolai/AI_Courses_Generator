{% extends "base.html" %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
{% endblock %}

{% block content %}
<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <h2>Finalizzazione del Corso</h2>
        <div>
            <a href="/corso/{{ corso_id }}/generazione" class="btn btn-outline-primary me-2">Torna alla Generazione</a>
            <a href="/corso/{{ corso_id }}" class="btn btn-outline-secondary">Torna al Corso</a>
        </div>
    </div>
    <p class="text-muted">{{ corso.parametri.titolo }}</p>
</div>

{% if not completato %}
<div class="alert alert-warning">
    <h4 class="alert-heading">Corso non completato</h4>
    <p>
        Il corso non è stato completato. Ci sono ancora capitoli da generare.
        Si consiglia di completare tutti i capitoli prima di procedere con l'esportazione.
    </p>
    <ul>
        {% for capitolo in capitoli_mancanti %}
        <li>{{ capitolo }}</li>
        {% endfor %}
    </ul>
    <a href="/corso/{{ corso_id }}/generazione" class="btn btn-primary">Torna alla generazione</a>
</div>
{% else %}
<div class="alert alert-success">
    <h4 class="alert-heading">Corso Completato!</h4>
    <p>Tutti i capitoli sono stati generati. Ora puoi esportare il corso nel formato desiderato.</p>
</div>
{% endif %}

<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h3 class="card-title h5 mb-0">Riepilogo del Corso</h3>
    </div>
    <div class="card-body">
        <h3>{{ corso.parametri.titolo }}</h3>
        <p>{{ corso.parametri.descrizione }}</p>
        
        <dl class="row">
            <dt class="col-sm-3">Pubblico target</dt>
            <dd class="col-sm-9">{{ corso.parametri.pubblico_target }}</dd>
            
            <dt class="col-sm-3">Livello di complessità</dt>
            <dd class="col-sm-9">{{ corso.parametri.livello_complessita }}</dd>
            
            <dt class="col-sm-3">Tono</dt>
            <dd class="col-sm-9">{{ corso.parametri.tono }}</dd>
            
            {% if corso.parametri.requisiti_specifici %}
            <dt class="col-sm-3">Requisiti specifici</dt>
            <dd class="col-sm-9">{{ corso.parametri.requisiti_specifici }}</dd>
            {% endif %}
            
            {% if corso.parametri.stile_scrittura %}
            <dt class="col-sm-3">Stile di scrittura</dt>
            <dd class="col-sm-9">{{ corso.parametri.stile_scrittura }}</dd>
            {% endif %}
        </dl>
        
        <h4 class="mt-4">Capitoli del corso:</h4>
        <ol class="list-group list-group-numbered">
            {% for capitolo in corso.scaletta.capitoli %}
            <li class="list-group-item">
                <div class="fw-bold">{{ capitolo.titolo }}</div>
                <p class="mb-0">{{ capitolo.descrizione }}</p>
                <ul class="mt-2 small">
                    {% for sottocapitolo in capitolo.sottocapitoli %}
                    <li>{{ sottocapitolo.titolo }}</li>
                    {% endfor %}
                </ul>
            </li>
            {% endfor %}
        </ol>
    </div>
</div>

{% if completato %}
<div class="card mb-4">
    <div class="card-header bg-success text-white">
        <h3 class="card-title h5 mb-0">Espansione dei Contenuti</h3>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-8">
                <h4>Migliora e Arricchisci i Contenuti</h4>
                <p>Espandi i contenuti di tutti i capitoli per renderli più dettagliati, discorsivi e coinvolgenti. L'AI analizzerà ogni capitolo e lo arricchirà mantenendo la struttura originale.</p>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    Questa operazione espanderà ogni capitolo di circa 3 volte la sua lunghezza attuale, aggiungendo esempi, spiegazioni più dettagliate e un linguaggio più naturale.
                </div>
            </div>
            <div class="col-md-4 d-flex align-items-center justify-content-center">
                <div class="text-center">
                    <i class="bi bi-arrows-expand" style="font-size: 3rem; color: #28a745;"></i>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <h5>Personalizza l'Espansione</h5>
            <form id="form-espandi">
                <div class="mb-3">
                    <label for="fattore-espansione" class="form-label">Fattore di espansione</label>
                    <select class="form-select" id="fattore-espansione" name="fattore_espansione">
                        <option value="2">2x (Moderato)</option>
                        <option value="3" selected>3x (Consigliato)</option>
                        <option value="4">4x (Esteso)</option>
                        <option value="5">5x (Massimo)</option>
                    </select>
                    <div class="form-text">Quanto vuoi espandere il contenuto rispetto all'originale.</div>
                </div>
                
                <div class="mb-3">
                    <label for="stile-espansione" class="form-label">Stile di scrittura</label>
                    <select class="form-select" id="stile-espansione" name="stile_espansione">
                        <option value="discorsivo" selected>Discorsivo e naturale</option>
                        <option value="accademico">Accademico e formale</option>
                        <option value="divulgativo">Divulgativo e semplice</option>
                        <option value="narrativo">Narrativo e coinvolgente</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Focus dell'espansione</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="esempi_pratici" id="focus-esempi" name="focus-espansione" checked>
                        <label class="form-check-label" for="focus-esempi">
                            Più esempi pratici
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="spiegazioni_dettagliate" id="focus-spiegazioni" name="focus-espansione" checked>
                        <label class="form-check-label" for="focus-spiegazioni">
                            Spiegazioni più dettagliate
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="analogie_metafore" id="focus-analogie" name="focus-espansione">
                        <label class="form-check-label" for="focus-analogie">
                            Analogie e metafore
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="approfondimenti_teorici" id="focus-approfondimenti" name="focus-espansione">
                        <label class="form-check-label" for="focus-approfondimenti">
                            Approfondimenti teorici
                        </label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="istruzioni-aggiuntive" class="form-label">Istruzioni aggiuntive (opzionale)</label>
                    <textarea class="form-control" id="istruzioni-aggiuntive" name="istruzioni_aggiuntive" rows="3" placeholder="Inserisci eventuali istruzioni specifiche per l'espansione..."></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Opzioni avanzate</label>
                    <div class="card">
                        <div class="card-body">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="continua-dopo-errore" name="continua_dopo_errore">
                                <label class="form-check-label" for="continua-dopo-errore">
                                    Continua con i capitoli successivi in caso di errore
                                </label>
                                <div class="form-text">Se selezionato, l'espansione continuerà con i capitoli successivi anche se un capitolo fallisce.</div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="pausa-tra-capitoli" class="form-label">Pause tra operazioni</label>
                                <div class="input-group mb-2">
                                    <span class="input-group-text">Capitoli</span>
                                    <input type="number" class="form-control" id="pausa-tra-capitoli" min="0" max="60" value="0">
                                    <span class="input-group-text">sec</span>
                                </div>
                                <div class="input-group">
                                    <span class="input-group-text">Sezioni</span>
                                    <input type="number" class="form-control" id="pausa-tra-sezioni" min="0" max="10" value="1">
                                    <span class="input-group-text">sec</span>
                                </div>
                                <div class="form-text">Aggiungi pause per ridurre il carico sul server e prevenire errori di connessione.</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex gap-2">
                    <button type="button" id="btn-verifica-api" class="btn btn-outline-secondary me-2">
                        <i class="bi bi-key me-2"></i>Verifica Chiave API
                    </button>
                    <button type="button" id="btn-modelli-disponibili" class="btn btn-outline-info me-2">
                        <i class="bi bi-list-check me-2"></i>Modelli Disponibili
                    </button>
                    <button type="button" id="btn-espandi" class="btn btn-success">
                        <i class="bi bi-arrows-expand me-2"></i>Espandi i Contenuti
                    </button>
                    <button type="button" id="btn-annulla-espansione" class="btn btn-outline-danger d-none">
                        <i class="bi bi-x-circle me-2"></i>Annulla Espansione
                    </button>
                    <button type="button" id="btn-pausa-espansione" class="btn btn-outline-warning d-none">
                        <i class="bi bi-pause-circle me-2"></i>Pausa
                    </button>
                    <button type="button" id="btn-riprendi-espansione" class="btn btn-outline-primary d-none">
                        <i class="bi bi-play-circle me-2"></i>Riprendi
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Sezione per il feedback progressivo -->
        <div id="espansione-progress" class="mt-4 d-none">
            <h5>Progresso Espansione</h5>
            <div class="progress mb-3">
                <div id="espansione-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
            
            <!-- Avviso per espansione interrotta con pulsante di ripresa -->
            <div id="espansione-interrotta-alert" class="alert alert-warning mb-3 d-none">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <span id="espansione-interrotta-messaggio">Espansione interrotta al capitolo 1/5 a causa di un errore.</span>
                    </div>
                    <button class="btn btn-warning btn-sm" id="btn-riprendi-da-errore">
                        <i class="bi bi-arrow-clockwise me-1"></i> Riprendi da dove interrotto
                    </button>
                </div>
            </div>
            
            <div id="espansione-capitoli-container">
                <!-- Qui verranno aggiunti dinamicamente gli stati dei capitoli -->
            </div>
            
            <div id="espansione-risultato" class="alert mt-3 d-none"></div>
        </div>
    </div>
</div>
{% endif %}

<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h3 class="card-title h5 mb-0">Esportazione del Corso</h3>
    </div>
</div>

<div class="card">
    <div class="card-header bg-primary text-white">
        <h3 class="card-title h5 mb-0">Opzioni di Esportazione</h3>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Markdown</h5>
                        <p class="card-text">Esporta il corso in formato Markdown, ideale per l'uso con piattaforme come GitHub, GitLab o altri editor che supportano Markdown.</p>
                        <button id="esporta-markdown" class="btn btn-primary">Esporta in Markdown</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">HTML</h5>
                        <p class="card-text">Esporta il corso in formato HTML, ideale per la pubblicazione su siti web o la visualizzazione in browser.</p>
                        <button id="esporta-html" class="btn btn-primary" disabled>Esporta in HTML (Prossimamente)</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">PDF</h5>
                        <p class="card-text">Esporta il corso in formato PDF, ideale per la stampa o la distribuzione come documento formale.</p>
                        <button id="esporta-pdf" class="btn btn-primary" disabled>Esporta in PDF (Prossimamente)</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">DOCX</h5>
                        <p class="card-text">Esporta il corso in formato Microsoft Word, ideale per l'ulteriore modifica con software di word processing.</p>
                        <button id="esporta-docx" class="btn btn-primary" disabled>Esporta in DOCX (Prossimamente)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal per la configurazione dell'espansione -->
<div class="modal fade" id="modalEspansione" tabindex="-1" aria-labelledby="modalEspansioneLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEspansioneLabel">Configurazione Espansione Contenuti</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="fattore-espansione" class="form-label">Fattore di espansione</label>
                        <select class="form-select" id="fattore-espansione">
                            <option value="2">Moderato (x2)</option>
                            <option value="3" selected>Standard (x3)</option>
                            <option value="4">Ampio (x4)</option>
                            <option value="5">Massimo (x5)</option>
                        </select>
                        <div class="form-text">Quanto vuoi espandere i contenuti rispetto all'originale.</div>
                    </div>
                    <div class="col-md-6">
                        <label for="stile-espansione" class="form-label">Stile dell'espansione</label>
                        <select class="form-select" id="stile-espansione">
                            <option value="discorsivo" selected>Discorsivo e scorrevole</option>
                            <option value="accademico">Accademico e dettagliato</option>
                            <option value="pratico">Pratico con esempi concreti</option>
                            <option value="educativo">Educativo e didattico</option>
                        </select>
                        <div class="form-text">Lo stile della prosa nell'espansione.</div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Focus dell'espansione</label>
                    <div class="form-check">
                        <input class="form-check-input focus-espansione" type="checkbox" value="esempi" id="focus-esempi" checked>
                        <label class="form-check-label" for="focus-esempi">
                            Esempi e casi d'uso
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input focus-espansione" type="checkbox" value="spiegazioni" id="focus-spiegazioni" checked>
                        <label class="form-check-label" for="focus-spiegazioni">
                            Spiegazioni più dettagliate
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input focus-espansione" type="checkbox" value="analogie" id="focus-analogie">
                        <label class="form-check-label" for="focus-analogie">
                            Analogie e metafore
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input focus-espansione" type="checkbox" value="approfondimenti" id="focus-approfondimenti">
                        <label class="form-check-label" for="focus-approfondimenti">
                            Approfondimenti tecnici
                        </label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="istruzioni-aggiuntive" class="form-label">Istruzioni aggiuntive (opzionale)</label>
                    <textarea class="form-control" id="istruzioni-aggiuntive" rows="3" placeholder="Eventuali istruzioni specifiche per l'espansione..."></textarea>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="continua-dopo-errore">
                            <label class="form-check-label" for="continua-dopo-errore">Continua dopo errori</label>
                        </div>
                        <div class="form-text">Se abilitato, l'espansione continuerà anche se alcuni capitoli falliscono.</div>
                    </div>
                    <div class="col-md-6">
                        <label for="pausa-tra-capitoli" class="form-label">Pausa tra capitoli (secondi)</label>
                        <input type="number" class="form-control" id="pausa-tra-capitoli" min="0" max="60" value="0">
                        <div class="form-text">Aggiungi una pausa tra l'espansione di capitoli successivi per ridurre il carico sul server.</div>
                    </div>
                </div>
                
                <!-- Pulsante per riprendere da dove si è interrotto (nascosto di default) -->
                <div id="btn-riprendi-da-errore" class="alert alert-warning d-none" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill me-2 fs-4"></i>
                        <div>
                            <h5 class="mb-1">Espansione interrotta</h5>
                            <p class="mb-2">L'ultima espansione è stata interrotta a causa di un errore. Puoi riprendere da dove si è fermata.</p>
                            <button class="btn btn-warning">
                                <i class="bi bi-arrow-repeat me-2"></i>Riprendi da dove interrotto
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-primary" id="btn-avvia-espansione">Avvia Espansione</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Funzione generica per l'esportazione
    function esportaCorso(formato, btnElement) {
        // Cambia lo stato del pulsante
        const originalText = btnElement.innerHTML;
        btnElement.disabled = true;
        btnElement.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Esportazione in corso...';
        
        // Chiama l'API per l'esportazione
        fetch(`/api/corso/{{ corso_id }}/esporta?formato=${formato}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error("Errore durante l'esportazione del corso");
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Gestione diversa per formati binari (PDF, DOCX) e testuali (Markdown, HTML)
                    if (data.is_binary) {
                        // Per i formati binari, convertiamo da base64 a Blob
                        const binaryData = atob(data.content);
                        const byteArray = new Uint8Array(binaryData.length);
                        for(let i = 0; i < binaryData.length; i++) {
                            byteArray[i] = binaryData.charCodeAt(i);
                        }
                        
                        // Determiniamo il MIME type in base al formato
                        let mimeType = 'application/octet-stream';
                        if (formato === 'pdf') {
                            mimeType = 'application/pdf';
                        } else if (formato === 'docx') {
                            mimeType = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
                        }
                        
                        // Creiamo un blob e lo scarichiamo
                        const blob = new Blob([byteArray], {type: mimeType});
                        const element = document.createElement('a');
                        element.href = URL.createObjectURL(blob);
                        element.download = data.filename;
                        document.body.appendChild(element);
                        element.click();
                        document.body.removeChild(element);
                    } else {
                        // Per i formati testuali, usiamo direttamente il contenuto
                        const mimeType = formato === 'html' ? 'text/html' : 'text/markdown';
                        const element = document.createElement('a');
                        const file = new Blob([data.content], {type: mimeType});
                        element.href = URL.createObjectURL(file);
                        element.download = data.filename;
                        document.body.appendChild(element);
                        element.click();
                        document.body.removeChild(element);
                    }
                    
                    // Mostra un messaggio di successo
                    alert("Corso esportato con successo!");
                } else {
                    alert(data.message || "Errore durante l'esportazione del corso");
                }
                
                // Ripristina lo stato del pulsante
                btnElement.disabled = false;
                btnElement.innerHTML = originalText;
            })
            .catch(error => {
                console.error('Errore:', error);
                alert("Si è verificato un errore durante l'esportazione. Riprova più tardi.");
                
                // Ripristina lo stato del pulsante
                btnElement.disabled = false;
                btnElement.innerHTML = originalText;
            });
    }
    
    // Configura i bottoni di esportazione
    const config = [
        { id: 'esporta-markdown', formato: 'markdown' },
        { id: 'esporta-html', formato: 'html' },
        { id: 'esporta-pdf', formato: 'pdf' },
        { id: 'esporta-docx', formato: 'docx' }
    ];
    
    // Collega i listener ai pulsanti
    config.forEach(item => {
        const btn = document.getElementById(item.id);
        if (btn) {
            // Rimuoviamo la disabilitazione dai pulsanti
            btn.disabled = false;
            
            // Rimuoviamo il testo "Prossimamente" dai pulsanti
            btn.innerHTML = btn.innerHTML.replace(' (Prossimamente)', '');
            
            // Aggiungiamo l'event listener
            btn.addEventListener('click', function() {
                esportaCorso(item.formato, this);
            });
        }
    });

    // Variabili per il controllo dell'espansione
    let espansioneInCorso = false;
    let espansionePausata = false;
    let espansioneAnnullata = false;
    let intervalloAggiornamento = null;
    
    // Funzione per aggiornare lo stato dell'espansione
    function aggiornaStatoEspansione() {
        fetch(`/api/corso/{{ corso_id }}/espansione-stato`)
            .then(response => response.json())
            .then(data => {
                // Se l'espansione è completata o fallita
                if (data.stato === "completato" || data.stato === "fallito" || data.stato === "parziale") {
                    // Ferma l'aggiornamento automatico
                    clearInterval(intervalloAggiornamento);
                    
                    // Termina l'espansione
                    espansioneInCorso = false;
                    
                    // Riabilita il pulsante di espansione
                    document.getElementById('btn-espandi').disabled = false;
                    document.getElementById('btn-espandi').innerHTML = '<i class="bi bi-arrows-expand me-2"></i>Espandi i Contenuti';
                    
                    // Nascondi i pulsanti di controllo
                    document.getElementById('btn-pausa-espansione').classList.add('d-none');
                    document.getElementById('btn-riprendi-espansione').classList.add('d-none');
                    document.getElementById('btn-annulla-espansione').classList.add('d-none');
                    
                    // Aggiorna la barra di progresso
                    const progressBar = document.getElementById('espansione-progress-bar');
                    const percentuale = data.capitoli_espansi / data.totale_capitoli * 100;
                    progressBar.style.width = `${percentuale}%`;
                    progressBar.setAttribute('aria-valuenow', percentuale);
                    progressBar.textContent = `${Math.round(percentuale)}%`;
                    
                    // Mostra un messaggio per le espansioni parziali/fallite con punto di ripresa
                    if ((data.stato === "parziale" || data.stato === "fallito") && data.punto_ripresa) {
                        const alertElement = document.getElementById('espansione-interrotta-alert');
                        const riprendiBtn = document.getElementById('btn-riprendi-da-errore');
                        
                        // Imposta i dati di ripresa sul bottone
                        riprendiBtn.dataset.capitoloRipresa = data.punto_ripresa.capitolo_id;
                        riprendiBtn.dataset.sezioneRipresa = data.punto_ripresa.sezione || 0;
                        
                        // Trova il titolo del capitolo
                        let titoloCapitolo = "capitolo";
                        for (const capitolo of data.dettagli_capitoli) {
                            if (capitolo.id === data.punto_ripresa.capitolo_id) {
                                titoloCapitolo = capitolo.titolo;
                                break;
                            }
                        }
                        
                        // Aggiorna il messaggio
                        document.getElementById('espansione-interrotta-messaggio').textContent = 
                            `Espansione interrotta al capitolo "${titoloCapitolo}" (sezione ${data.punto_ripresa.sezione || 0}) a causa di un errore.`;
                        
                        // Mostra l'alert
                        alertElement.classList.remove('d-none');
                    }
                    
                    // Aggiorna i dettagli dei capitoli
                    const capitoliContainer = document.getElementById('espansione-capitoli-container');
                    capitoliContainer.innerHTML = '';
                    
                    data.dettagli_capitoli.forEach(capitolo => {
                        const capitoloElement = document.createElement('div');
                        capitoloElement.className = 'card mb-2';
                        
                        let statusClass = 'bg-secondary';
                        let statusIcon = 'bi-hourglass-split';
                        
                        if (capitolo.espanso) {
                            statusClass = 'bg-success';
                            statusIcon = 'bi-check-circle-fill';
                        } else if (capitolo.in_elaborazione) {
                            statusClass = 'bg-primary';
                            statusIcon = 'bi-gear-fill';
                        } else if (capitolo.errore) {
                            statusClass = 'bg-danger';
                            statusIcon = 'bi-x-circle-fill';
                        }
                        
                        let dettagliHtml = '';
                        if (capitolo.espanso) {
                            dettagliHtml = `
                                <p class="mb-0 small">
                                    <span class="badge bg-light text-dark">Originale: ${capitolo.lunghezza_originale} caratteri</span>
                                    <span class="badge bg-light text-dark">Espanso: ${capitolo.lunghezza_espansa} caratteri</span>
                                    <span class="badge bg-light text-dark">Fattore: ${capitolo.fattore_reale}x</span>
                                    ${capitolo.num_sezioni ? `<span class="badge bg-light text-dark">Sezioni: ${capitolo.num_sezioni}</span>` : ''}
                                </p>
                            `;
                        } else if (capitolo.in_elaborazione) {
                            dettagliHtml = `
                                <p class="mb-0 small">
                                    <span class="badge bg-primary">In elaborazione</span>
                                    ${capitolo.sezione_corrente ? `<span class="badge bg-info">Sezione: ${capitolo.sezione_corrente}/${capitolo.totale_sezioni || '?'}</span>` : ''}
                                    <span class="spinner-border spinner-border-sm text-primary ms-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </span>
                                </p>
                            `;
                        } else {
                            dettagliHtml = `<p class="mb-0 small text-secondary">${capitolo.messaggio || 'In attesa di elaborazione'}</p>`;
                        }
                        
                        // Prepara i bottoni di azione
                        let azioniHtml = '';
                        
                        // Non mostrare bottoni se c'è un'espansione in corso
                        if (!espansioneInCorso) {
                            // Bottone espandi singolo capitolo (solo se non è già espanso)
                            if (!capitolo.espanso && !capitolo.in_elaborazione) {
                                azioniHtml += `
                                    <button type="button" class="btn btn-sm btn-success btn-espandi-capitolo me-1" 
                                            data-capitolo-id="${capitolo.id}" data-capitolo-titolo="${capitolo.titolo}">
                                        <i class="bi bi-arrows-expand"></i> Espandi
                                    </button>
                                `;
                            }
                            
                            // Bottone riprendi (solo se c'è un errore)
                            if (capitolo.errore) {
                                azioniHtml += `
                                    <button type="button" class="btn btn-sm btn-warning btn-riprendi-capitolo"
                                            data-capitolo-id="${capitolo.id}" data-capitolo-titolo="${capitolo.titolo}"
                                            data-sezione="${capitolo.sezione_corrente || 0}">
                                        <i class="bi bi-arrow-clockwise"></i> Riprendi
                                    </button>
                                `;
                            }
                        }
                        
                        // Aggiungi le azioni se presenti
                        const azioniContainer = azioniHtml ? `
                            <div class="mt-2">
                                ${azioniHtml}
                            </div>
                        ` : '';
                        
                        capitoloElement.innerHTML = `
                            <div class="card-body py-2">
                                <div class="d-flex align-items-center">
                                    <i class="bi ${statusIcon} me-2 ${capitolo.espanso ? 'text-success' : (capitolo.in_elaborazione ? 'text-primary' : 'text-secondary')}"></i>
                                    <div class="w-100">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">${capitolo.titolo}</h6>
                                            ${capitolo.in_elaborazione ? '<span class="badge bg-primary">In corso</span>' : ''}
                                        </div>
                                        ${dettagliHtml}
                                        ${azioniContainer}
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        capitoliContainer.appendChild(capitoloElement);
                    });
                    
                    // Mostra il risultato finale
                    const risultatoElement = document.getElementById('espansione-risultato');
                    risultatoElement.classList.remove('d-none');
                    
                    if (data.success) {
                        risultatoElement.className = 'alert alert-success mt-3';
                        risultatoElement.innerHTML = `<i class="bi bi-check-circle-fill me-2"></i>${data.message}`;
                    } else {
                        risultatoElement.className = 'alert alert-danger mt-3';
                        risultatoElement.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-2"></i>${data.message}`;
                    }
                } else if (data.stato === "in_pausa") {
                    // Espansione in pausa
                    espansionePausata = true;
                    document.getElementById('btn-pausa-espansione').classList.add('d-none');
                    document.getElementById('btn-riprendi-espansione').classList.remove('d-none');
                } else {
                    // Espansione in corso
                    // Aggiorna la barra di progresso
                    const progressBar = document.getElementById('espansione-progress-bar');
                    const percentuale = data.capitoli_espansi / data.totale_capitoli * 100;
                    progressBar.style.width = `${percentuale}%`;
                    progressBar.setAttribute('aria-valuenow', percentuale);
                    progressBar.textContent = `${Math.round(percentuale)}%`;
                    
                    // Aggiorna i dettagli dei capitoli
                    const capitoliContainer = document.getElementById('espansione-capitoli-container');
                    capitoliContainer.innerHTML = '';
                    
                    data.dettagli_capitoli.forEach(capitolo => {
                        const capitoloElement = document.createElement('div');
                        capitoloElement.className = 'card mb-2';
                        
                        let statusClass = 'bg-secondary';
                        let statusIcon = 'bi-hourglass-split';
                        
                        if (capitolo.espanso) {
                            statusClass = 'bg-success';
                            statusIcon = 'bi-check-circle-fill';
                        } else if (capitolo.in_elaborazione) {
                            statusClass = 'bg-primary';
                            statusIcon = 'bi-gear-fill';
                        } else if (capitolo.errore) {
                            statusClass = 'bg-danger';
                            statusIcon = 'bi-x-circle-fill';
                        }
                        
                        let dettagliHtml = '';
                        if (capitolo.espanso) {
                            dettagliHtml = `
                                <p class="mb-0 small">
                                    <span class="badge bg-light text-dark">Originale: ${capitolo.lunghezza_originale} caratteri</span>
                                    <span class="badge bg-light text-dark">Espanso: ${capitolo.lunghezza_espansa} caratteri</span>
                                    <span class="badge bg-light text-dark">Fattore: ${capitolo.fattore_reale}x</span>
                                    ${capitolo.num_sezioni ? `<span class="badge bg-light text-dark">Sezioni: ${capitolo.num_sezioni}</span>` : ''}
                                </p>
                            `;
                        } else if (capitolo.in_elaborazione) {
                            dettagliHtml = `
                                <p class="mb-0 small">
                                    <span class="badge bg-primary">In elaborazione</span>
                                    ${capitolo.sezione_corrente ? `<span class="badge bg-info">Sezione: ${capitolo.sezione_corrente}/${capitolo.totale_sezioni || '?'}</span>` : ''}
                                    <span class="spinner-border spinner-border-sm text-primary ms-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </span>
                                </p>
                            `;
                        } else {
                            dettagliHtml = `<p class="mb-0 small text-secondary">${capitolo.messaggio || 'In attesa di elaborazione'}</p>`;
                        }
                        
                        capitoloElement.innerHTML = `
                            <div class="card-body py-2">
                                <div class="d-flex align-items-center">
                                    <i class="bi ${statusIcon} me-2 ${capitolo.espanso ? 'text-success' : (capitolo.in_elaborazione ? 'text-primary' : 'text-secondary')}"></i>
                                    <div class="w-100">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">${capitolo.titolo}</h6>
                                            ${capitolo.in_elaborazione ? '<span class="badge bg-primary">In corso</span>' : ''}
                                        </div>
                                        ${dettagliHtml}
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        capitoliContainer.appendChild(capitoloElement);
                    });
                }
            })
            .catch(error => {
                console.error('Errore nel recupero dello stato dell\'espansione:', error);
            });
    }
    
    // Gestione dell'espansione dei contenuti
    const btnEspandi = document.getElementById('btn-espandi');
    const btnAnnulla = document.getElementById('btn-annulla-espansione');
    const btnPausa = document.getElementById('btn-pausa-espansione');
    const btnRiprendi = document.getElementById('btn-riprendi-espansione');
    
    if (btnEspandi) {
        btnEspandi.addEventListener('click', function() {
            // Raccogli i dati dal form
            const formEspansione = document.getElementById('form-espandi');
            const fattoreEspansione = parseInt(document.getElementById('fattore-espansione').value);
            const stileEspansione = document.getElementById('stile-espansione').value;
            
            // Raccogli i focus selezionati
            const focusCheckboxes = formEspansione.querySelectorAll('input[name="focus-espansione"]:checked');
            const focusEspansione = Array.from(focusCheckboxes).map(cb => cb.value);
            
            // Raccogli le istruzioni aggiuntive
            const istruzioniAggiuntive = document.getElementById('istruzioni-aggiuntive').value;
            
            // Raccogli le opzioni avanzate
            const continuaDopoErrore = document.getElementById('continua-dopo-errore').checked;
            const pausaTraCapitoli = parseInt(document.getElementById('pausa-tra-capitoli').value) || 0;
            const pausaTraSezioni = parseInt(document.getElementById('pausa-tra-sezioni').value) || 1;
            
            // Prepara i dati per la richiesta
            const datiEspansione = {
                fattore_espansione: fattoreEspansione,
                stile_espansione: stileEspansione,
                focus_espansione: focusEspansione,
                istruzioni_aggiuntive: istruzioniAggiuntive,
                continua_dopo_errore: continuaDopoErrore,
                pausa_tra_capitoli: pausaTraCapitoli,
                pausa_tra_sezioni: pausaTraSezioni
            };
            
            // Mostra la sezione di progresso
            const progressSection = document.getElementById('espansione-progress');
            progressSection.classList.remove('d-none');
            
            // Resetta il contenitore dei capitoli
            const capitoliContainer = document.getElementById('espansione-capitoli-container');
            capitoliContainer.innerHTML = '';
            
            // Disabilita il pulsante durante l'elaborazione
            btnEspandi.disabled = true;
            btnEspandi.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Espansione in corso...';
            
            // Mostra i pulsanti di controllo
            btnAnnulla.classList.remove('d-none');
            btnPausa.classList.remove('d-none');
            
            // Imposta lo stato dell'espansione
            espansioneInCorso = true;
            espansionePausata = false;
            espansioneAnnullata = false;
            
            // Effettua la richiesta API
            fetch(`/api/corso/{{ corso_id }}/espandi`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datiEspansione)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Errore durante l'espansione dei contenuti");
                }
                return response.json();
            })
            .then(data => {
                // Aggiorna la barra di progresso
                const progressBar = document.getElementById('espansione-progress-bar');
                const percentuale = data.capitoli_espansi / data.totale_capitoli * 100;
                progressBar.style.width = `${percentuale}%`;
                progressBar.setAttribute('aria-valuenow', percentuale);
                progressBar.textContent = `${Math.round(percentuale)}%`;
                
                // Mostra i dettagli di ogni capitolo
                data.dettagli_capitoli.forEach(capitolo => {
                    const capitoloElement = document.createElement('div');
                    capitoloElement.className = 'card mb-2';
                    
                    let statusClass = 'bg-secondary';
                    let statusIcon = 'bi-hourglass-split';
                    
                    if (capitolo.espanso) {
                        statusClass = 'bg-success';
                        statusIcon = 'bi-check-circle-fill';
                    } else if (capitolo.in_elaborazione) {
                        statusClass = 'bg-primary';
                        statusIcon = 'bi-gear-fill';
                    } else if (capitolo.errore) {
                        statusClass = 'bg-danger';
                        statusIcon = 'bi-x-circle-fill';
                    }
                    
                    let dettagliHtml = '';
                    if (capitolo.espanso) {
                        dettagliHtml = `
                            <p class="mb-0 small">
                                <span class="badge bg-light text-dark">Originale: ${capitolo.lunghezza_originale} caratteri</span>
                                <span class="badge bg-light text-dark">Espanso: ${capitolo.lunghezza_espansa} caratteri</span>
                                <span class="badge bg-light text-dark">Fattore: ${capitolo.fattore_reale}x</span>
                                ${capitolo.num_sezioni ? `<span class="badge bg-light text-dark">Sezioni: ${capitolo.num_sezioni}</span>` : ''}
                            </p>
                        `;
                    } else if (capitolo.in_elaborazione) {
                        dettagliHtml = `
                            <p class="mb-0 small">
                                <span class="badge bg-primary">In elaborazione</span>
                                ${capitolo.sezione_corrente ? `<span class="badge bg-info">Sezione: ${capitolo.sezione_corrente}/${capitolo.totale_sezioni || '?'}</span>` : ''}
                                <span class="spinner-border spinner-border-sm text-primary ms-2" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </span>
                            </p>
                        `;
                    } else {
                        dettagliHtml = `<p class="mb-0 small text-secondary">${capitolo.messaggio || 'In attesa di elaborazione'}</p>`;
                    }
                    
                    // Prepara i bottoni di azione
                    let azioniHtml = '';
                    
                    // Non mostrare bottoni se c'è un'espansione in corso
                    if (!espansioneInCorso) {
                        // Bottone espandi singolo capitolo (solo se non è già espanso)
                        if (!capitolo.espanso && !capitolo.in_elaborazione) {
                            azioniHtml += `
                                <button type="button" class="btn btn-sm btn-success btn-espandi-capitolo me-1" 
                                        data-capitolo-id="${capitolo.id}" data-capitolo-titolo="${capitolo.titolo}">
                                    <i class="bi bi-arrows-expand"></i> Espandi
                                </button>
                            `;
                        }
                        
                        // Bottone riprendi (solo se c'è un errore)
                        if (capitolo.errore) {
                            azioniHtml += `
                                <button type="button" class="btn btn-sm btn-warning btn-riprendi-capitolo"
                                        data-capitolo-id="${capitolo.id}" data-capitolo-titolo="${capitolo.titolo}"
                                        data-sezione="${capitolo.sezione_corrente || 0}">
                                    <i class="bi bi-arrow-clockwise"></i> Riprendi
                                </button>
                            `;
                        }
                    }
                    
                    // Aggiungi le azioni se presenti
                    const azioniContainer = azioniHtml ? `
                        <div class="mt-2">
                            ${azioniHtml}
                        </div>
                    ` : '';
                    
                    capitoloElement.innerHTML = `
                        <div class="card-body py-2">
                            <div class="d-flex align-items-center">
                                <i class="bi ${statusIcon} me-2 ${capitolo.espanso ? 'text-success' : (capitolo.in_elaborazione ? 'text-primary' : 'text-secondary')}"></i>
                                <div class="w-100">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">${capitolo.titolo}</h6>
                                        ${capitolo.in_elaborazione ? '<span class="badge bg-primary">In corso</span>' : ''}
                                    </div>
                                    ${dettagliHtml}
                                    ${azioniContainer}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    capitoliContainer.appendChild(capitoloElement);
                });
                
                // Mostra il risultato finale
                const risultatoElement = document.getElementById('espansione-risultato');
                risultatoElement.classList.remove('d-none');
                
                if (data.success) {
                    risultatoElement.className = 'alert alert-success mt-3';
                    risultatoElement.innerHTML = `<i class="bi bi-check-circle-fill me-2"></i>${data.message}`;
                } else {
                    risultatoElement.className = 'alert alert-danger mt-3';
                    risultatoElement.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-2"></i>${data.message}`;
                }
                
                // Riabilita il pulsante
                btnEspandi.disabled = false;
                btnEspandi.innerHTML = '<i class="bi bi-arrows-expand me-2"></i>Espandi i Contenuti';
                
                // Nascondi i pulsanti di controllo
                btnAnnulla.classList.add('d-none');
                btnPausa.classList.add('d-none');
                btnRiprendi.classList.add('d-none');
                
                // Termina l'espansione
                espansioneInCorso = false;
            })
            .catch(error => {
                console.error('Errore:', error);
                
                // Mostra l'errore
                const risultatoElement = document.getElementById('espansione-risultato');
                risultatoElement.classList.remove('d-none');
                risultatoElement.className = 'alert alert-danger mt-3';
                risultatoElement.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-2"></i>Errore durante l'espansione: ${error.message}`;
                
                // Riabilita il pulsante
                btnEspandi.disabled = false;
                btnEspandi.innerHTML = '<i class="bi bi-arrows-expand me-2"></i>Espandi i Contenuti';
                
                // Nascondi i pulsanti di controllo
                btnAnnulla.classList.add('d-none');
                btnPausa.classList.add('d-none');
                btnRiprendi.classList.add('d-none');
                
                // Termina l'espansione
                espansioneInCorso = false;
            });
            
            // Avvia l'intervallo di aggiornamento
            intervalloAggiornamento = setInterval(aggiornaStatoEspansione, 5000);
        });
    }
    
    // Gestione del pulsante di annullamento
    if (btnAnnulla) {
        btnAnnulla.addEventListener('click', function() {
            if (!espansioneInCorso) return;
            
            if (confirm('Sei sicuro di voler annullare l\'espansione in corso?')) {
                fetch(`/api/corso/{{ corso_id }}/espansione-annulla`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        espansioneAnnullata = true;
                        
                        // Mostra un messaggio
                        const risultatoElement = document.getElementById('espansione-risultato');
                        risultatoElement.classList.remove('d-none');
                        risultatoElement.className = 'alert alert-warning mt-3';
                        risultatoElement.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-2"></i>Espansione annullata dall'utente.`;
                        
                        // Nascondi i pulsanti di controllo
                        btnAnnulla.classList.add('d-none');
                        btnPausa.classList.add('d-none');
                        btnRiprendi.classList.add('d-none');
                        
                        // Riabilita il pulsante di espansione
                        btnEspandi.disabled = false;
                        btnEspandi.innerHTML = '<i class="bi bi-arrows-expand me-2"></i>Espandi i Contenuti';
                        
                        // Termina l'espansione
                        espansioneInCorso = false;
                        clearInterval(intervalloAggiornamento);
                    }
                })
                .catch(error => {
                    console.error('Errore nell\'annullamento dell\'espansione:', error);
                });
            }
        });
    }
    
    // Gestione del pulsante di pausa
    if (btnPausa) {
        btnPausa.addEventListener('click', function() {
            if (!espansioneInCorso || espansionePausata) return;
            
            fetch(`/api/corso/{{ corso_id }}/espansione-pausa`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    espansionePausata = true;
                    btnPausa.classList.add('d-none');
                    btnRiprendi.classList.remove('d-none');
                    
                    // Mostra un messaggio
                    const risultatoElement = document.getElementById('espansione-risultato');
                    risultatoElement.classList.remove('d-none');
                    risultatoElement.className = 'alert alert-info mt-3';
                    risultatoElement.innerHTML = `<i class="bi bi-pause-circle-fill me-2"></i>Espansione in pausa. Clicca su "Riprendi" per continuare.`;
                }
            })
            .catch(error => {
                console.error('Errore nella pausa dell\'espansione:', error);
            });
        });
    }
    
    // Gestione del pulsante di ripresa
    if (btnRiprendi) {
        btnRiprendi.addEventListener('click', function() {
            if (!espansioneInCorso || !espansionePausata) return;
            
            fetch(`/api/corso/{{ corso_id }}/espansione-riprendi`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    espansionePausata = false;
                    btnRiprendi.classList.add('d-none');
                    btnPausa.classList.remove('d-none');
                    
                    // Mostra un messaggio
                    const risultatoElement = document.getElementById('espansione-risultato');
                    risultatoElement.classList.remove('d-none');
                    risultatoElement.className = 'alert alert-info mt-3';
                    risultatoElement.innerHTML = `<i class="bi bi-play-circle-fill me-2"></i>Espansione ripresa.`;
                }
            })
            .catch(error => {
                console.error('Errore nella ripresa dell\'espansione:', error);
            });
        });
    }

    // Gestione del pulsante di ripresa dopo errore
    document.getElementById('btn-riprendi-da-errore').addEventListener('click', function() {
        const capitoloId = this.dataset.capitoloRipresa;
        const sezione = parseInt(this.dataset.sezioneRipresa || "0");
        
        if (!capitoloId) {
            alert("Dati di ripresa non validi.");
            return;
        }
        
        // Raccogli i parametri dal form
        const fattoreEspansione = parseInt(document.getElementById('fattore-espansione').value);
        const stileEspansione = document.getElementById('stile-espansione').value;
        const focusCheckboxes = document.querySelectorAll('input[name="focus-espansione"]:checked');
        const focusEspansione = Array.from(focusCheckboxes).map(cb => cb.value);
        const istruzioniAggiuntive = document.getElementById('istruzioni-aggiuntive').value;
        const pausaTraSezioni = parseInt(document.getElementById('pausa-tra-sezioni').value) || 1;
        
        const parametri = {
            fattore_espansione: fattoreEspansione,
            stile_espansione: stileEspansione,
            focus_espansione: focusEspansione,
            istruzioni_aggiuntive: istruzioniAggiuntive,
            pausa_tra_sezioni: pausaTraSezioni,
            capitolo_ripresa: capitoloId,
            sezione_ripresa: sezione,
            continua_dopo_errore: true
        };
        
        // Nascondi l'alert di interruzione
        document.getElementById('espansione-interrotta-alert').classList.add('d-none');
        
        // Imposta lo stato dell'espansione
        espansioneInCorso = true;
        
        // Disabilita il pulsante di espansione
        document.getElementById('btn-espandi').disabled = true;
        document.getElementById('btn-espandi').innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Espansione in corso...';
        
        // Mostra i pulsanti di controllo
        document.getElementById('btn-annulla-espansione').classList.remove('d-none');
        document.getElementById('btn-pausa-espansione').classList.remove('d-none');
        
        // Effettua la richiesta API
        fetch(`/api/corso/{{ corso_id }}/espandi-capitolo/${capitoloId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(parametri)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("Errore durante la ripresa dell'espansione");
            }
            return response.json();
        })
        .then(data => {
            // Avvia l'aggiornamento dello stato
            intervalloAggiornamento = setInterval(aggiornaStatoEspansione, 2000);
        })
        .catch(error => {
            console.error('Errore:', error);
            
            // Riabilita il pulsante
            document.getElementById('btn-espandi').disabled = false;
            document.getElementById('btn-espandi').innerHTML = '<i class="bi bi-arrows-expand me-2"></i>Espandi i Contenuti';
            
            // Mostra l'errore
            const risultatoElement = document.getElementById('espansione-risultato');
            risultatoElement.classList.remove('d-none');
            risultatoElement.className = 'alert alert-danger mt-3';
            risultatoElement.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-2"></i>Errore durante la ripresa dell'espansione: ${error.message}`;
            
            // Termina l'espansione
            espansioneInCorso = false;
        });
    });

    // Gestione del pulsante di verifica della chiave API
    const btnVerificaAPI = document.getElementById('btn-verifica-api');
    if (btnVerificaAPI) {
        btnVerificaAPI.addEventListener('click', function() {
            // Disabilita il pulsante durante la verifica
            btnVerificaAPI.disabled = true;
            btnVerificaAPI.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Verifica in corso...';
            
            // Effettua la richiesta API
            fetch('/api/verifica-chiave-api')
                .then(response => response.json())
                .then(data => {
                    // Riabilita il pulsante
                    btnVerificaAPI.disabled = false;
                    btnVerificaAPI.innerHTML = '<i class="bi bi-key me-2"></i>Verifica Chiave API';
                    
                    // Mostra il risultato
                    const risultatoElement = document.getElementById('espansione-risultato');
                    risultatoElement.classList.remove('d-none');
                    
                    if (data.success) {
                        risultatoElement.className = 'alert alert-success mt-3';
                        risultatoElement.innerHTML = `<i class="bi bi-check-circle-fill me-2"></i>Chiave API valida. Puoi procedere con l'espansione.`;
                        
                        // Abilita il pulsante di espansione
                        document.getElementById('btn-espandi').disabled = false;
                    } else {
                        risultatoElement.className = 'alert alert-danger mt-3';
                        risultatoElement.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-2"></i>Errore: ${data.message}`;
                        
                        // Disabilita il pulsante di espansione
                        document.getElementById('btn-espandi').disabled = true;
                    }
                    
                    // Mostra la sezione di progresso
                    document.getElementById('espansione-progress').classList.remove('d-none');
                })
                .catch(error => {
                    console.error('Errore:', error);
                    
                    // Riabilita il pulsante
                    btnVerificaAPI.disabled = false;
                    btnVerificaAPI.innerHTML = '<i class="bi bi-key me-2"></i>Verifica Chiave API';
                    
                    // Mostra l'errore
                    const risultatoElement = document.getElementById('espansione-risultato');
                    risultatoElement.classList.remove('d-none');
                    risultatoElement.className = 'alert alert-danger mt-3';
                    risultatoElement.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-2"></i>Errore durante la verifica della chiave API: ${error.message}`;
                    
                    // Mostra la sezione di progresso
                    document.getElementById('espansione-progress').classList.remove('d-none');
                });
        });
    }

    // Gestione del pulsante per visualizzare i modelli disponibili
    const btnModelliDisponibili = document.getElementById('btn-modelli-disponibili');
    if (btnModelliDisponibili) {
        btnModelliDisponibili.addEventListener('click', function() {
            // Disabilita il pulsante durante la richiesta
            btnModelliDisponibili.disabled = true;
            btnModelliDisponibili.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Caricamento...';
            
            // Effettua la richiesta API
            fetch('/api/modelli-disponibili')
                .then(response => response.json())
                .then(data => {
                    // Riabilita il pulsante
                    btnModelliDisponibili.disabled = false;
                    btnModelliDisponibili.innerHTML = '<i class="bi bi-list-check me-2"></i>Modelli Disponibili';
                    
                    // Mostra il risultato
                    const risultatoElement = document.getElementById('espansione-risultato');
                    risultatoElement.classList.remove('d-none');
                    
                    if (data.success) {
                        // Filtra i modelli per mostrare solo quelli più rilevanti
                        const modelli_alta_qualita = data.modelli_alta_qualita || [];
                        
                        let modelli_html = '';
                        if (modelli_alta_qualita.length > 0) {
                            modelli_html = `
                                <h5 class="mt-3">Modelli di alta qualità disponibili:</h5>
                                <ul class="list-group">
                                    ${modelli_alta_qualita.map(m => `<li class="list-group-item">${m}</li>`).join('')}
                                </ul>
                            `;
                        } else {
                            modelli_html = `
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    Non sono stati trovati modelli di alta qualità disponibili per il tuo account.
                                </div>
                            `;
                        }
                        
                        risultatoElement.className = 'alert alert-info mt-3';
                        risultatoElement.innerHTML = `
                            <h4><i class="bi bi-list-check me-2"></i>Modelli Disponibili</h4>
                            <p>Sono stati trovati ${data.modelli.length} modelli disponibili per il tuo account.</p>
                            ${modelli_html}
                            <div class="mt-3">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-mostra-tutti-modelli">
                                    Mostra tutti i modelli
                                </button>
                                <div class="collapse mt-2" id="tutti-modelli">
                                    <div class="card card-body">
                                        <h6>Tutti i modelli disponibili:</h6>
                                        <ul class="list-group">
                                            ${data.modelli.map(m => `<li class="list-group-item">${m}</li>`).join('')}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Aggiungi event listener per il pulsante "Mostra tutti i modelli"
                        document.getElementById('btn-mostra-tutti-modelli').addEventListener('click', function() {
                            const tuttiModelliElement = document.getElementById('tutti-modelli');
                            if (tuttiModelliElement.classList.contains('show')) {
                                tuttiModelliElement.classList.remove('show');
                                this.textContent = 'Mostra tutti i modelli';
                            } else {
                                tuttiModelliElement.classList.add('show');
                                this.textContent = 'Nascondi tutti i modelli';
                            }
                        });
                    } else {
                        risultatoElement.className = 'alert alert-danger mt-3';
                        risultatoElement.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-2"></i>Errore: ${data.message}`;
                    }
                    
                    // Mostra la sezione di progresso
                    document.getElementById('espansione-progress').classList.remove('d-none');
                })
                .catch(error => {
                    console.error('Errore:', error);
                    
                    // Riabilita il pulsante
                    btnModelliDisponibili.disabled = false;
                    btnModelliDisponibili.innerHTML = '<i class="bi bi-list-check me-2"></i>Modelli Disponibili';
                    
                    // Mostra l'errore
                    const risultatoElement = document.getElementById('espansione-risultato');
                    risultatoElement.classList.remove('d-none');
                    risultatoElement.className = 'alert alert-danger mt-3';
                    risultatoElement.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-2"></i>Errore durante il recupero dei modelli disponibili: ${error.message}`;
                    
                    // Mostra la sezione di progresso
                    document.getElementById('espansione-progress').classList.remove('d-none');
                });
        });
    }

    // Funzione per avviare l'espansione
    function avviaEspansione(parametri) {
        // Disabilita il pulsante durante l'espansione
        btnEspandi.disabled = true;
        btnEspandi.innerHTML = '<i class="bi bi-arrows-expand me-2"></i>Espansione in corso...';
        
        // Mostra i controlli di pausa e annullamento
        document.getElementById('btn-pausa-espansione').classList.remove('d-none');
        document.getElementById('btn-annulla-espansione').classList.remove('d-none');
        
        // Nascondi il risultato precedente
        document.getElementById('espansione-risultato').classList.add('d-none');
        
        // Resetta la barra di progresso
        const progressBar = document.getElementById('espansione-progress-bar');
        progressBar.style.width = '0%';
        progressBar.setAttribute('aria-valuenow', 0);
        progressBar.textContent = '0%';
        
        // Mostra la barra di progresso
        document.getElementById('espansione-progress').classList.remove('d-none');
        
        // Salva i parametri in localStorage per un eventuale ripresa
        localStorage.setItem('ultimiParametriEspansione', JSON.stringify(parametri));
        
        // Invia la richiesta di espansione
        fetch(`/api/corso/{{ corso_id }}/espandi`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(parametri)
        })
        .then(response => response.json())
        .then(data => {
            espansioneInCorso = true;
            intervalloAggiornamento = setInterval(aggiornaStatoEspansione, 2000);
        })
        .catch(error => {
            console.error('Errore:', error);
            btnEspandi.disabled = false;
            btnEspandi.innerHTML = '<i class="bi bi-arrows-expand me-2"></i>Espandi i Contenuti';
            document.getElementById('espansione-risultato').classList.remove('d-none');
            document.getElementById('espansione-risultato').className = 'alert alert-danger mt-3';
            document.getElementById('espansione-risultato').innerHTML = `<i class="bi bi-exclamation-triangle-fill me-2"></i>Errore durante l'avvio dell'espansione: ${error.message || 'Errore sconosciuto'}`;
        });
    }

    // Gestione del form di espansione
    document.getElementById('form-espandi').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Raccogli i parametri dal form
        const parametri = {
            fattore_espansione: parseInt(document.getElementById('fattore-espansione').value),
            stile_espansione: document.getElementById('stile-espansione').value,
            focus_espansione: Array.from(document.querySelectorAll('input[name="focus-espansione"]:checked')).map(cb => cb.value),
            istruzioni_aggiuntive: document.getElementById('istruzioni-aggiuntive').value,
            continua_dopo_errore: document.getElementById('continua-dopo-errore').checked,
            pausa_tra_capitoli: parseInt(document.getElementById('pausa-tra-capitoli').value)
        };
        
        // Avvia l'espansione
        avviaEspansione(parametri);
    });

    // Aggiungi event delegation per i pulsanti di espansione dei singoli capitoli
    document.getElementById('espansione-capitoli-container').addEventListener('click', function(e) {
        // Bottone per espandere un singolo capitolo
        if (e.target.closest('.btn-espandi-capitolo')) {
            const button = e.target.closest('.btn-espandi-capitolo');
            const capitoloId = button.dataset.capitoloId;
            const capitoloTitolo = button.dataset.capitoloTitolo;
            
            if (confirm(`Vuoi espandere il capitolo "${capitoloTitolo}"?`)) {
                // Disabilita il pulsante durante l'elaborazione
                button.disabled = true;
                button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Espansione...';
                
                // Raccogli i parametri dal form
                const fattoreEspansione = parseInt(document.getElementById('fattore-espansione').value);
                const stileEspansione = document.getElementById('stile-espansione').value;
                const focusCheckboxes = document.querySelectorAll('input[name="focus-espansione"]:checked');
                const focusEspansione = Array.from(focusCheckboxes).map(cb => cb.value);
                const istruzioniAggiuntive = document.getElementById('istruzioni-aggiuntive').value;
                const pausaTraSezioni = parseInt(document.getElementById('pausa-tra-sezioni').value) || 1;
                
                const parametri = {
                    fattore_espansione: fattoreEspansione,
                    stile_espansione: stileEspansione,
                    focus_espansione: focusEspansione,
                    istruzioni_aggiuntive: istruzioniAggiuntive,
                    pausa_tra_sezioni: pausaTraSezioni
                };
                
                // Mostra la sezione di progresso
                const progressSection = document.getElementById('espansione-progress');
                progressSection.classList.remove('d-none');
                
                // Imposta lo stato dell'espansione
                espansioneInCorso = true;
                
                // Effettua la richiesta API per espandere il singolo capitolo
                fetch(`/api/corso/{{ corso_id }}/espandi-capitolo/${capitoloId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(parametri)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Errore durante l'espansione del capitolo");
                    }
                    return response.json();
                })
                .then(data => {
                    // Avvia l'aggiornamento dello stato
                    intervalloAggiornamento = setInterval(aggiornaStatoEspansione, 2000);
                })
                .catch(error => {
                    console.error('Errore:', error);
                    
                    // Riabilita il pulsante
                    button.disabled = false;
                    button.innerHTML = '<i class="bi bi-arrows-expand"></i> Espandi';
                    
                    // Mostra l'errore
                    const risultatoElement = document.getElementById('espansione-risultato');
                    risultatoElement.classList.remove('d-none');
                    risultatoElement.className = 'alert alert-danger mt-3';
                    risultatoElement.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-2"></i>Errore durante l'espansione del capitolo: ${error.message}`;
                    
                    // Termina l'espansione
                    espansioneInCorso = false;
                });
            }
        }
        
        // Bottone per riprendere l'espansione di un capitolo interrotto
        if (e.target.closest('.btn-riprendi-capitolo')) {
            const button = e.target.closest('.btn-riprendi-capitolo');
            const capitoloId = button.dataset.capitoloId;
            const capitoloTitolo = button.dataset.capitoloTitolo;
            const sezione = parseInt(button.dataset.sezione) || 0;
            
            if (confirm(`Vuoi riprendere l'espansione del capitolo "${capitoloTitolo}" dalla sezione ${sezione}?`)) {
                // Disabilita il pulsante durante l'elaborazione
                button.disabled = true;
                button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Ripresa...';
                
                // Raccogli i parametri dal form
                const fattoreEspansione = parseInt(document.getElementById('fattore-espansione').value);
                const stileEspansione = document.getElementById('stile-espansione').value;
                const focusCheckboxes = document.querySelectorAll('input[name="focus-espansione"]:checked');
                const focusEspansione = Array.from(focusCheckboxes).map(cb => cb.value);
                const istruzioniAggiuntive = document.getElementById('istruzioni-aggiuntive').value;
                const pausaTraSezioni = parseInt(document.getElementById('pausa-tra-sezioni').value) || 1;
                
                const parametri = {
                    fattore_espansione: fattoreEspansione,
                    stile_espansione: stileEspansione,
                    focus_espansione: focusEspansione,
                    istruzioni_aggiuntive: istruzioniAggiuntive,
                    pausa_tra_sezioni: pausaTraSezioni,
                    capitolo_ripresa: capitoloId,
                    sezione_ripresa: sezione
                };
                
                // Mostra la sezione di progresso
                const progressSection = document.getElementById('espansione-progress');
                progressSection.classList.remove('d-none');
                
                // Imposta lo stato dell'espansione
                espansioneInCorso = true;
                
                // Effettua la richiesta API per riprendere l'espansione del capitolo
                fetch(`/api/corso/{{ corso_id }}/espandi-capitolo/${capitoloId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(parametri)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Errore durante la ripresa dell'espansione");
                    }
                    return response.json();
                })
                .then(data => {
                    // Avvia l'aggiornamento dello stato
                    intervalloAggiornamento = setInterval(aggiornaStatoEspansione, 2000);
                })
                .catch(error => {
                    console.error('Errore:', error);
                    
                    // Riabilita il pulsante
                    button.disabled = false;
                    button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Riprendi';
                    
                    // Mostra l'errore
                    const risultatoElement = document.getElementById('espansione-risultato');
                    risultatoElement.classList.remove('d-none');
                    risultatoElement.className = 'alert alert-danger mt-3';
                    risultatoElement.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-2"></i>Errore durante la ripresa dell'espansione: ${error.message}`;
                    
                    // Termina l'espansione
                    espansioneInCorso = false;
                });
            }
        }
    });
});
</script>
{% endblock %} 